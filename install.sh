#!/bin/bash

# ==============================================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ TTS
# ==============================================================================
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
# 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã (Python, build-essential).
# 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ NVIDIA (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ).
# 3. –°–æ–∑–¥–∞–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python (venv).
# 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–µ—Ä—Å–∏—é CUDA –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é
#    –≤–µ—Ä—Å–∏—é PyTorch —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π GPU.
# 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.
# 6. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ–Ω—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (—Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è).
#
# ==============================================================================

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
PYTHON_VERSION="3.10"
VENV_DIR="venv"

# --- –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# --- –§—É–Ω–∫—Ü–∏–∏ ---

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
setup_venv() {
    if [ ! -f "$VENV_DIR/bin/python" ]; then
        echo -e "${BLUE}–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ '$VENV_DIR' —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º python${PYTHON_VERSION}...${NC}"
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ä–∞–±–æ—á–∏–º venv
        if [ -d "$VENV_DIR" ]; then
            rm -rf "$VENV_DIR"
        fi
        "python${PYTHON_VERSION}" -m venv "$VENV_DIR"
        if [ $? -ne 0 ]; then
            echo -e "${RED}–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ 'python${PYTHON_VERSION}-venv' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
            exit 1
        fi
    else
        echo -e "${GREEN}–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '$VENV_DIR' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.${NC}"
    fi
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
install_environment() {
    echo -e "${BLUE}--- –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---${NC}"

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
    echo -e "\n${YELLOW}--> 1.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤...${NC}"
    
    REQUIRED_PKGS=( "build-essential" "python${PYTHON_VERSION}" "python${PYTHON_VERSION}-dev" "python${PYTHON_VERSION}-venv" "ffmpeg" "sox" "libsndfile1" )
    PKGS_TO_INSTALL=()

    for pkg in "${REQUIRED_PKGS[@]}"; do
        if ! dpkg-query -W -f='${Status}' "$pkg" 2>/dev/null | grep -q "install ok installed"; then
            PKGS_TO_INSTALL+=("$pkg")
        fi
    done

    if [ ${#PKGS_TO_INSTALL[@]} -ne 0 ]; then
        echo "–°–ª–µ–¥—É—é—â–∏–µ –ø–∞–∫–µ—Ç—ã –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: ${PKGS_TO_INSTALL[*]}"
        sudo apt-get update
        sudo apt-get install -y "${PKGS_TO_INSTALL[@]}"
        if [ $? -ne 0 ]; then
            echo -e "${RED}–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥.${NC}"
            exit 1
        fi
    else
        echo -e "${GREEN}–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.${NC}"
    fi

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ NVIDIA
    echo -e "\n${YELLOW}--> 1.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥—Ä–∞–π–≤–µ—Ä–æ–≤ NVIDIA...${NC}"
    if ! command -v nvidia-smi &> /dev/null; then
        echo -e "${RED}–û–®–ò–ë–ö–ê: –î—Ä–∞–π–≤–µ—Ä—ã NVIDIA –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ('nvidia-smi' –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞).${NC}"
        echo -e "${YELLOW}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã NVIDIA –¥–ª—è –≤–∞—à–µ–π –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã."
        echo -e "–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ${RED}–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–ï–†–ï–ó–ê–ì–†–£–ó–ò–¢–ï${NC} –∫–æ–º–ø—å—é—Ç–µ—Ä –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞."
        exit 1
    fi
    echo -e "${GREEN}–î—Ä–∞–π–≤–µ—Ä—ã NVIDIA –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã.${NC}"
    nvidia-smi

    # 3. –°–æ–∑–¥–∞–Ω–∏–µ VENV
    echo -e "\n${YELLOW}--> 1.3 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è Python...${NC}"
    setup_venv

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ PyTorch
    echo -e "\n${YELLOW}--> 1.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ PyTorch —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π GPU...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ —É–∂–µ PyTorch —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CUDA
    if "$VENV_DIR/bin/python" -c "import torch; exit(0) if torch.cuda.is_available() else exit(1)" &>/dev/null; then
        PYTORCH_VERSION=$("$VENV_DIR/bin/python" -c "import torch; print(torch.__version__)")
        echo -e "${GREEN}PyTorch ($PYTORCH_VERSION) —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π CUDA —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.${NC}"
    else
        echo -e "${BLUE}PyTorch —Å CUDA –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–µ–Ω. –ù–∞—á–∏–Ω–∞—é —É—Å—Ç–∞–Ω–æ–≤–∫—É...${NC}"
        
        CUDA_VERSION_STRING=$(nvidia-smi | grep "CUDA Version:" | awk '{print $9}')
        if [ -z "$CUDA_VERSION_STRING" ]; then
            echo -e "${RED}–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Ä—Å–∏—é CUDA –∏–∑ –≤—ã–≤–æ–¥–∞ 'nvidia-smi'.${NC}"
            exit 1
        fi
        
        CUDA_MAJOR=$(echo "$CUDA_VERSION_STRING" | cut -d'.' -f1)
        PYTORCH_URL=""

        if [[ "$CUDA_MAJOR" -ge "12" ]]; then
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ CUDA ${CUDA_VERSION_STRING}. –í—ã–±–∏—Ä–∞–µ–º PyTorch –¥–ª—è CUDA 12.1."
            PYTORCH_URL="https://download.pytorch.org/whl/cu121"
        elif [[ "$CUDA_MAJOR" -ge "11" ]]; then
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ CUDA ${CUDA_VERSION_STRING}. –í—ã–±–∏—Ä–∞–µ–º PyTorch –¥–ª—è CUDA 11.8."
            PYTORCH_URL="https://download.pytorch.org/whl/cu118"
        else
            echo -e "${RED}–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º—É—é –≤–µ—Ä—Å–∏—é PyTorch –¥–ª—è –≤–∞—à–µ–π CUDA (${CUDA_VERSION_STRING}).${NC}"
            exit 1
        fi

        "$VENV_DIR/bin/pip" install torch torchvision torchaudio --index-url "$PYTORCH_URL"
        if [ $? -ne 0 ]; then
            echo -e "${RED}–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ PyTorch. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥.${NC}"
            exit 1
        fi
        echo -e "${GREEN}PyTorch —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
    fi

    # 5. –û—á–∏—Å—Ç–∫–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    echo -e "\n${YELLOW}--> 1.5 –û—á–∏—Å—Ç–∫–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"

    # –£–¥–∞–ª—è–µ–º torchvision –∏ torchaudio, —Ç.–∫. –æ–Ω–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏ –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –≤–µ—Ä—Å–∏–µ–π torch
    echo "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ (torchvision, torchaudio)..."
    "$VENV_DIR/bin/pip" uninstall -y torchvision torchaudio &>/dev/null

    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ requirements.txt..."
    "$VENV_DIR/bin/pip" install --upgrade -r requirements.txt
    if [ $? -ne 0 ]; then
        echo -e "${RED}–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ Python –ø–∞–∫–µ—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ 'requirements.txt' –∏ –≤—ã–≤–æ–¥ –æ—à–∏–±–æ–∫.${NC}"
        exit 1
    fi
    echo -e "${GREEN}–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.${NC}"
    
    echo -e "\n${GREEN}=======================================================${NC}"
    echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
    echo -e "${GREEN}=======================================================${NC}"
}

# –§—É–Ω–∫—Ü–∏—è —É–º–Ω–æ–π —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –∞—É–¥–∏–æ
segment_audio() {
    echo -e "${BLUE}--- –®–∞–≥ 2.1: –£–º–Ω–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∞—É–¥–∏–æ ---${NC}"
    
    SRC_DIR="data/audio"
    DEST_DIR="data/segment_audio"
    mkdir -p "$SRC_DIR" "$DEST_DIR"
    
    echo -e "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤: ${YELLOW}$SRC_DIR${NC}"
    echo "–ù–∞–∂–º–∏—Ç–µ Enter, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å..."
    read
    
    if [ -z "$(ls -A $SRC_DIR 2>/dev/null)" ]; then
       echo -e "${YELLOW}–ü–∞–ø–∫–∞ $SRC_DIR –ø—É—Å—Ç–∞. –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.${NC}"
       return
    fi
    
    if [ ! -f "$VENV_DIR/bin/python" ]; then
        echo -e "${RED}Python –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É (–ø—É–Ω–∫—Ç 1).${NC}"
        return
    fi

    echo "–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —É–º–Ω–æ–π —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏..."
    "$VENV_DIR/bin/python" smart_segmenter.py --input_dir "$SRC_DIR" --output_dir "$DEST_DIR"
    echo -e "${GREEN}–£–º–Ω–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.${NC}"
}

# –§—É–Ω–∫—Ü–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
transcribe_data() {
    echo -e "${BLUE}--- –®–∞–≥ 2.2: –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∞—É–¥–∏–æ ---${NC}"
    
    if [ ! -f "$VENV_DIR/bin/python" ]; then
        echo -e "${RED}Python –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É (–ø—É–Ω–∫—Ç 1).${NC}"
        return
    fi
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–∑–º–µ—Ä –ø–∞—á–∫–∏
    echo -e "${YELLOW}–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ (batch size) –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏.${NC}"
    echo "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: 16 (–¥–ª—è 24–ì–ë VRAM), 8 (–¥–ª—è 16–ì–ë VRAM), 4 (–¥–ª—è 8-12–ì–ë VRAM)."
    read -p "–í–∞—à –≤—ã–±–æ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 16): " BATCH_SIZE
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –≤–≤–µ–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    : "${BATCH_SIZE:=8}"
    
    echo "–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ —Å —Ä–∞–∑–º–µ—Ä–æ–º –ø–∞—á–∫–∏: $BATCH_SIZE..."
    "$VENV_DIR/bin/python" transcribe.py --data_dir="data/segment_audio" --output_dir="data/dataset" --batch_size="$BATCH_SIZE"
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}–í–æ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ï—Å–ª–∏ —ç—Ç–æ 'Out of Memory', –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ø–∞—á–∫–∏.${NC}"
    else
        echo -e "${GREEN}–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.${NC}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—É—á–µ–Ω–∏—è
train_model() {
    echo -e "${BLUE}--- –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ —É–º–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è ---${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    if [ ! -f "$VENV_DIR/bin/python" ]; then
        echo -e "${RED}Python –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É (–ø—É–Ω–∫—Ç 1).${NC}"
        return
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ Smart Tuner
    if [ ! -f "smart_tuner_main.py" ]; then
        echo -e "${RED}Smart Tuner (smart_tuner_main.py) –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ.${NC}"
        return
    fi

    TRAIN_FILE="data/dataset/train.csv"
    if [ ! -f "$TRAIN_FILE" ] || [ ! -s "$TRAIN_FILE" ]; then
        echo -e "${RED}–§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è ($TRAIN_FILE) –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç.${NC}"
        echo -e "${YELLOW}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —à–∞–≥–∏ 2.1 (–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è) –∏ 2.2 (–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è).${NC}"
        return
    fi

    echo -e "${GREEN}ü§ñ –ó–∞–ø—É—Å–∫ Smart Tuner V2 –≤ —Ä–µ–∂–∏–º–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è...${NC}"
    echo "–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:"
    echo "  ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç –æ–±—É—á–µ–Ω–∏–µ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫–ø–æ–∏–Ω—Ç–∞"
    echo "  ‚úÖ –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—É—á—à–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
    echo "  ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏ –∏–ª–∏ —Å—Ç–∞–≥–Ω–∞—Ü–∏–∏"
    echo "  ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç –ª—É—á—à—É—é –º–æ–¥–µ–ª—å –∏ –≤—Å–µ –ª–æ–≥–∏ –≤ MLflow"
    echo "  ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)"
    echo -e "${YELLOW}–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –≤ —ç—Ç–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.${NC}"
    echo

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏ Telegram –≤ config.yaml
    if ! grep -q 'enabled: true' smart_tuner/config.yaml; then
        echo -e "${YELLOW}üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):${NC}"
        echo "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –æ–±—É—á–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –±–æ—Ç–∞:"
        echo -n "Telegram Bot Token (Enter –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞): "
        read -r BOT_TOKEN
        
        if [ -n "$BOT_TOKEN" ]; then
            echo -n "Telegram Chat ID: "
            read -r CHAT_ID
            
            if [ -n "$CHAT_ID" ];
            then
                echo -e "${GREEN}‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...${NC}"
                # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                sed -i 's/enabled: false/enabled: true/' smart_tuner/config.yaml
                sed -i "s/bot_token: .*/bot_token: \"$BOT_TOKEN\"/" smart_tuner/config.yaml
                sed -i "s/chat_id: .*/chat_id: \"$CHAT_ID\"/" smart_tuner/config.yaml
                echo "‚úì Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã"
            fi
        else
            echo "‚è≠Ô∏è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω—ã"
        fi
    else
        echo "‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã."
    fi

    # --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ ---
    echo -e "\n${YELLOW}üóëÔ∏è  –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –Ω–æ–≤–æ–º—É –∑–∞–ø—É—Å–∫—É...${NC}"
    
    # 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    pkill -f "tensorboard" &>/dev/null
    pkill -f "mlflow" &>/dev/null
    pkill -f "smart_tuner/web_interfaces.py" &>/dev/null
    sleep 1
    echo "‚úì –°—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

    # 2. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    rm -rf output/ mlruns/ smart_tuner/models/ tensorboard.log mlflow.log smart_tuner_main.log smart_tuner/optuna_studies.db
    mkdir -p output/ mlruns/ smart_tuner/models/
    echo "‚úì –°—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —É–¥–∞–ª–µ–Ω—ã, –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã"

    # 3. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    echo -e "\n${GREEN}üìä –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...${NC}"
    IP_ADDR=$(hostname -I | awk '{print $1}')
    if [ -z "$IP_ADDR" ]; then
        IP_ADDR="localhost"
    fi

    nohup "$VENV_DIR/bin/python" -m tensorboard.main --logdir "output/" --host 0.0.0.0 --port 5001 --reload_interval 5 > tensorboard.log 2>&1 &
    echo "‚úì TensorBoard –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5001"

    nohup "$VENV_DIR/bin/mlflow" ui --host 0.0.0.0 --port 5000 --backend-store-uri "file://$(pwd)/mlruns" > mlflow.log 2>&1 &
    echo "‚úì MLflow UI –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5000"
    sleep 3

    echo -e "\n${BLUE}üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å–∞–º (—á–µ—Ä–µ–∑ ~1-2 –º–∏–Ω—É—Ç—ã):${NC}"
    echo -e "  MLflow:      ${GREEN}http://${IP_ADDR}:5000${NC}"
    echo -e "  TensorBoard: ${GREEN}http://${IP_ADDR}:5001${NC}"
    echo

    # 4. –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å Smart Tuner
    echo -e "${GREEN}üöÄ –ó–∞–ø—É—Å–∫ Smart Tuner...${NC}"
    "$VENV_DIR/bin/python" smart_tuner_main.py --mode train

    if [ $? -eq 0 ]; then
        echo -e "\n${GREEN}üéâ –û–±—É—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
        echo -e "${YELLOW}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤:${NC}"
        echo "  üìÅ –ú–æ–¥–µ–ª–∏: output/ –∏ smart_tuner/models/"
        echo "  üìä –õ–æ–≥–∏: mlruns/"
        echo "  üìã –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏: smart_tuner_main.log"
    else
        echo -e "\n${RED}‚ùå –í–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.${NC}"
        echo -e "${YELLOW}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:${NC}"
        echo "  tail -f smart_tuner_main.log"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-–¥–µ–º–æ TTS
run_tts_demo() {
    echo -e "${BLUE}--- –ó–∞–ø—É—Å–∫ –≤–µ–±-–¥–µ–º–æ TTS ---${NC}"
    
    if [ ! -f "$VENV_DIR/bin/python" ]; then
        echo -e "${RED}Python –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É (–ø—É–Ω–∫—Ç 1).${NC}"
        return
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤
    if [ -z "$(find output/ -name 'checkpoint_*' 2>/dev/null)" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è –ß–µ–∫–ø–æ–∏–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ø–∞–ø–∫–µ output/.${NC}"
        echo -e "${YELLOW}–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–±—É—á–µ–Ω–∏–µ –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑.${NC}"
        echo -e "${YELLOW}–î–µ–º–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –Ω–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è –º–æ–¥–µ–ª–∏.${NC}"
        echo
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Streamlit
    if ! "$VENV_DIR/bin/python" -c "import streamlit" &>/dev/null; then
        echo -e "${YELLOW}Streamlit –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...${NC}"
        "$VENV_DIR/bin/pip" install streamlit
    fi
    
    IP_ADDR=$(hostname -I | awk '{print $1}')
    if [ -z "$IP_ADDR" ]; then
        IP_ADDR="localhost"
    fi
    
    echo -e "${GREEN}üé§ –ó–∞–ø—É—Å–∫ TTS Demo –Ω–∞ –ø–æ—Ä—Ç—É 5005...${NC}"
    echo -e "${BLUE}–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: ${GREEN}http://${IP_ADDR}:5005${NC}"
    echo -e "${YELLOW}–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C${NC}"
    echo
    
    # –ó–∞–ø—É—Å–∫ Streamlit
    "$VENV_DIR/bin/streamlit" run demo.py \
        --server.port 5005 \
        --server.address 0.0.0.0 \
        --browser.gatherUsageStats false
}

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ª–∞–¥–∫–∏ –æ–±—É—á–µ–Ω–∏—è
debug_training() {
    echo -e "${BLUE}--- –ó–∞–ø—É—Å–∫ –æ—Ç–ª–∞–¥—á–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è ---${NC}"
    if [ ! -f "debug_train.sh" ]; then
        echo -e "${RED}–°–∫—Ä–∏–ø—Ç –æ—Ç–ª–∞–¥–∫–∏ 'debug_train.sh' –Ω–µ –Ω–∞–π–¥–µ–Ω.${NC}"
        return
    fi
    bash ./debug_train.sh
}

# –ú–µ–Ω—é —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞—Å–µ—Ç–æ–º
dataset_menu() {
    while true; do
        echo -e "\n${YELLOW}--- –ú–µ–Ω—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö ---${NC}"
        echo "1. –£–º–Ω–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∞—É–¥–∏–æ (–∏–∑ /data/audio –≤ /data/segment_audio)"
        echo "2. –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –∞—É–¥–∏–æ (–∏–∑ /data/segment_audio –≤ /data/dataset)"
        echo "0. –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
        echo -n "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é: "
        read -r choice
        
        case $choice in
            1) segment_audio ;;
            2) transcribe_data ;;
            0) break ;;
            *) echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.${NC}" ;;
        esac
    done
}

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
main_menu() {
    while true; do
        echo -e "\n${YELLOW}--- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ ---${NC}"
        echo "0. –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ —à–∞–≥–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É (1 -> 2.1 -> 2.2 -> 3)"
        echo "1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        echo "2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è)"
        echo "3. –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏"
        echo "4. –ó–∞–ø—É—Å–∫ –≤–µ–±-–¥–µ–º–æ TTS (Streamlit –Ω–∞ –ø–æ—Ä—Ç—É 5005)"
        echo "5. –û—Ç–ª–∞–¥–∏—Ç—å –∑–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è"
        echo "---"
        echo "9. –í—ã—Ö–æ–¥"
        echo -n "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é: "
        read -r choice
        
        case $choice in
            0)
                echo -e "${BLUE}--- –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —à–∞–≥–æ–≤ ---${NC}"
                install_environment
                segment_audio
                transcribe_data
                train_model
                echo -e "${GREEN}–í—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!${NC}"
                ;;
            1) install_environment ;;
            2) dataset_menu ;;
            3) train_model ;;
            4) run_tts_demo ;;
            5) debug_training ;;
            9) exit 0 ;;
            *) echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.${NC}" ;;
        esac
    done
}

# --- –ó–∞–ø—É—Å–∫ ---
main_menu 